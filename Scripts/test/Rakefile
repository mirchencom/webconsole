require 'shellwords'

WEB_CONSOLE_TESTS_DIRECTORY = File.expand_path(File.dirname(__FILE__))

task :default => [:xcunit, :web_console, :gems, :plugins]

task :long => [:default, :web_console_long]

task :web_console => ['web_console:tests']
task :web_console_long => ['web_console_long:tests']
task :xcunit => ['xcunit:tests']
task :gems => ['gems:tests']
task :plugins => ['plugins:tests']


namespace :gems do

  webconsole_gem_tests_rakefile = File.join(WEB_CONSOLE_TESTS_DIRECTORY, "../../Web Console/webconsole/test/Rakefile")
  load webconsole_gem_tests_rakefile

  task :tests => [:test_webconsole]

  task :test_webconsole => ['webconsole:clean_up']

end


namespace :plugins do

  wcack_test_rakefile = File.expand_path(File.join(WEB_CONSOLE_TESTS_DIRECTORY, "../..", "Web Console", "Ack", "wcack", "test", "Rakefile"))
  load wcack_test_rakefile

  task :tests => [:test_wcack]

  task :test_wcack => ['wcack:tests']

end


namespace :xcunit do

  task :tests => ['test_xcunit']

  task :test_xcunit do
    xcodebuild_scheme = "Web Console"
    xcodebuild_project_file = File.expand_path(File.join(WEB_CONSOLE_TESTS_DIRECTORY, "../../Web Console/Web Console.xcodeproj"))
    sh "xcodebuild test -scheme #{Shellwords.escape(xcodebuild_scheme)} -project #{Shellwords.escape(xcodebuild_project_file)}"
  end

end


namespace :web_console do

  task :tests => [:clean_up]

  task :test_web_console do
    web_console_tests_file = File.join(WEB_CONSOLE_TESTS_DIRECTORY, "tc_web_console.rb")
    ruby Shellwords.escape(web_console_tests_file)
  end

  task :clean_up => [:test_web_console] do
    data_directory = File.join(WEB_CONSOLE_TESTS_DIRECTORY, "data")
    quit_applescript_file = File.join(data_directory, "quit.applescript")
    sh "osascript #{Shellwords.escape(quit_applescript_file)}"
  end

end


namespace :web_console_long do

  task :tests => [:clean_up]

  task :test_web_console_long do
    web_console_tests_long_file = File.join(WEB_CONSOLE_TESTS_DIRECTORY, "tc_web_console_long.rb")
    ruby Shellwords.escape(web_console_tests_long_file)
  end

  task :clean_up => [:test_web_console_long] do
    data_directory = File.join(WEBCONSOLE_TESTS_DIRECTORY, "data")
    quit_applescript_file = File.join(data_directory, "quit.applescript")
    sh "osascript #{Shellwords.escape(quit_applescript_file)}"
  end

end
